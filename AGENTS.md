# AGENTS.md

Cross-agent policies for Shadow Workipedia. All AI agents (Claude, Codex, etc.) should follow these conventions.

## Project Overview

Shadow Workipedia is a standalone interactive graph visualization and wiki for Shadow Work's global issues catalog. It extracts data from the parent Shadow Work monorepo and builds a static website.

**Repository Structure:**
```
shadow-workipedia/
├── public/
│   ├── data.json              # Generated - DO NOT EDIT MANUALLY
│   ├── agent-priors.v1.json   # Agent behavior priors data
│   ├── agent-vocab.v1.json    # Agent vocabulary data
│   └── shadow-country-map.json # Country mapping data
├── scripts/
│   ├── extract-data.ts        # Data extraction from parent repo
│   ├── fill-mechanics-wiki.ts # Mechanics wiki population
│   ├── backfill-issue-mechanics.ts
│   └── ... (15+ utility scripts)
├── src/
│   ├── main.ts                # Application entry point (~3400 lines)
│   ├── graph.ts               # D3 force simulation
│   ├── interactions.ts        # Pan/zoom/click handlers
│   ├── article.ts             # Wiki article rendering
│   ├── agentGenerator.ts      # Agent generation orchestrator
│   ├── agentNarration.ts      # Agent narration system (Tracery-based)
│   ├── agentsView.ts          # Agent panel UI
│   ├── style.css              # Styles
│   ├── types.ts               # TypeScript interfaces
│   └── agent/                 # Modular agent generation facets
│       ├── generator.ts       # Main orchestrator (~3500 lines)
│       ├── latents.ts         # Hidden psychological attributes
│       ├── types.ts           # Agent type definitions
│       ├── utils.ts           # Seeded RNG, weighted picking, culture blending
│       └── facets/            # 14 domain-specific generation modules
│           ├── identity.ts    # Names, languages, gender, career tracks
│           ├── geography.ts   # Origin, citizenship, culture blending
│           ├── appearance.ts  # Height, build, hair, voice
│           ├── aptitudes.ts   # Physical/cognitive/social abilities
│           ├── traits.ts      # Big-5 personality traits
│           ├── capabilities.ts# Orchestrates aptitudes→traits→skills
│           ├── skills.ts      # Derived competencies (10+ skills)
│           ├── psychology.ts  # Ethics, contradictions, visibility
│           ├── preferences.ts # Food, media, fashion, routines
│           ├── lifestyle.ts   # Health, vices, spirituality
│           ├── social.ts      # Family, network, reputation
│           ├── domestic.ts    # Housing, legal status, life skills
│           ├── narrative.ts   # Timeline events, minority status
│           └── simulation.ts  # Day-0 needs, mood, break risk
├── wiki/
│   ├── issues/                # ~370 issue wiki articles (*.md)
│   ├── systems/               # ~35 system wiki articles (*.md)
│   ├── mechanics/             # ~40 mechanic wiki articles (*.md)
│   ├── primitives/            # ~16 primitive wiki articles (*.md)
│   ├── principles/            # ~1120 principle wiki articles (*.md)
│   └── communities/           # ~23 community wiki articles (*.md)
├── index.html                 # Single-page app entry
└── CLAUDE.md                  # Claude-specific guidance
```

## Critical Rules

### 1. Never Edit Generated Files
- `public/data.json` is generated by `pnpm extract-data`
- Edit the source files in the parent repo instead, then re-extract

### 2. Data Pipeline
```bash
# After changes to parent repo catalog/connections:
pnpm extract-data    # Regenerate data.json from parent repo

# Development
pnpm dev             # Start dev server (localhost:3000)

# Before deployment
pnpm build:full      # Extract data + build
```

### 3. Wiki Article Format

#### Issue Articles (`wiki/issues/`)
All issue wiki articles follow this structure:

```markdown
---
id: kebab-case-id
title: Human Readable Title
number: 123
category: Economic|Social|Political|Environmental|Security|Technological|Cultural|Infrastructure
urgency: Critical|High|Medium|Low|Latent
tags:
  - tag1
  - tag2
publicConcern: 0-100
economicImpact: 0-100
socialImpact: 0-100
affectedSystems:
  - System Name
connections:
  - related-issue-id
editedBy: Shadow Work Team
lastUpdated: YYYY-MM-DD
---

## Overview
[Main content...]

## Game Mechanics
### Parameter Effects
[Effects on simulation parameters...]

### Event Types
[Types of events this issue can trigger...]

## Cascading Effects
[How this connects to other issues...]

## Warning Signs
[Real-world indicators...]
```

#### Mechanic Articles (`wiki/mechanics/`)
Mechanics describe causal structure patterns - HOW issues perpetuate themselves:

```markdown
---
id: mechanic--{pattern}--{slug}
title: Mechanic Name (pattern)
pattern: pattern-name
mechanic: Mechanic Name
editedBy: Shadow Work Team
lastUpdated: YYYY-MM-DD
---
# Mechanic Name

## Overview
[One-line definition of the mechanic]

## How it works
- **State/Resource:** What state or resource is affected
- **Drivers:** What causes this dynamic
- **Outcomes:** What results from this dynamic

## In the simulation
- **Signals:** Observable indicators in game
- **Levers:** Player actions that can influence this
- **Failure modes:** Ways intervention can backfire

## Notes
[Additional context, real-world examples]

## References (System Walk occurrences)
[Auto-generated list of issues using this mechanic]
```

**Current mechanics (39 total):**
- adverse-selection, arms-race, brain-drain, capacity-erosion, cascade
- collective-action-problem, concentration, contagion, credibility-trap
- demographic-transition, dependency, deterrence-failure, escalation
- externality, feedback-loop, free-rider, institutional-capture
- irreversibility, legitimacy-crisis, lock-in, lobbying, market-failure
- misaligned-incentives, moral-hazard, normalization, path-dependency
- polarization, power-vacuum, principal-agent, race-to-bottom
- regime-shift, regulatory-capture, rent-seeking, resource-curse
- stochastic-shock, substitution-effect, threshold, tragedy-of-commons
- vicious-cycle

### 4. GitHub Edit Links
Wiki articles include an "Edit on GitHub" link at the bottom. The filename in the URL **must match** the actual file name exactly:

```markdown
**Edit on GitHub**: [Suggest changes](https://github.com/mistakeknot/shadow-workipedia/edit/main/wiki/issues/EXACT-FILENAME.md)
```

### 5. Initialization Order (src/main.ts)
Components must initialize in this order:
1. Canvas setup and context
2. Transform state and graph simulation
3. State variables
4. DOM elements
5. Event handlers
6. Canvas interaction handlers
7. Render function
8. **Finally:** `resizeCanvas()` (calls render internally)

Calling `resizeCanvas()` before dependencies are initialized causes ReferenceError.

## Development Workflow

### Making Changes
1. **Code changes**: Edit `src/*.ts`, use `pnpm dev` for HMR
2. **Style changes**: Edit `src/style.css`, HMR updates instantly
3. **Wiki content**: Edit `wiki/issues/*.md` or `wiki/systems/*.md`, then `pnpm extract-data`
4. **Data schema**: Edit `scripts/extract-data.ts`, then `pnpm extract-data`

### Type Checking
```bash
pnpm typecheck       # Run TypeScript compiler checks
```

### Building
```bash
pnpm build           # TypeScript + Vite production build
pnpm preview         # Preview production build (localhost:4173)
```

## File Organization

### Source Files (`src/`)
- `main.ts` - Main application (~3400 lines, orchestrates everything)
- `graph.ts` - D3 force simulation wrapper
- `interactions.ts` - Mouse/touch handlers for canvas
- `article.ts` - Wiki article and router logic
- `agentGenerator.ts` - Agent generation orchestrator (delegates to `src/agent/`)
- `agentNarration.ts` - Agent narration/speech generation (Tracery-based)
- `agentsView.ts` - Agent panel UI and interactions (~2000 lines)
- `types.ts` - TypeScript type definitions
- `style.css` - All styles (no CSS modules)

### Agent Generation System (`src/agent/`)

Modular facet architecture for procedural agent generation with **cross-facet correlates** ensuring realistic attribute relationships.

**Core Modules:**
- `generator.ts` - Orchestrates 14 facets in dependency order
- `latents.ts` - Hidden psychological attributes (0-1000 scale)
- `types.ts` - TypeScript interfaces for all agent data
- `utils.ts` - Seeded RNG, `weightedPick()`, culture blending helpers

**Key Patterns:**
- **Seeded RNG**: All randomness uses `makeRng(facetSeed(seed, 'facetName'))` for reproducibility
- **Weighted Picking**: Major decisions use `weightedPick(rng, [{item, weight}])` with context-specific weights
- **Culture Blending**: Primary weights interpolate between culture-specific and global pools
- **Correlate System**: 15+ cross-facet correlations ensure realistic attribute relationships

**Correlates (Cross-Facet Relationships):**

| # | Correlate | Mechanism |
|---|-----------|-----------|
| 2 | Tier ↔ Health | Elite: better healthcare; Mass: occupational risks |
| 3 | Tier ↔ Education | Elite: graduate/doctorate; Mass: trade/practical |
| 4 | Age ↔ Family | Marriage/children peak 28-45 |
| 5 | Cosmopolitanism ↔ Diaspora | High cosmo → expat/dual-citizen |
| 6 | Age ↔ Network Role | Young: peripheral; Senior: hub/gatekeeper |
| 7 | Religiosity ↔ Vices | Strict observance reduces vices 70% |
| 9 | Travel ↔ Skills | Travel boosts surveillance, tradecraft, negotiation |
| 11 | Empathy+Deception ↔ Network | High empathy → connector; High deception → broker |
| 12 | Authoritarianism ↔ Conflict Style | High auth → competing; Low auth → collaborative |
| 13 | Conscientiousness ↔ Housing | High → stable (owned); Low → chaotic (transient) |
| 14 | Visibility ↔ Reputation | High visibility → defined/polarizing reputations |
| 15 | Risk ↔ Housing | High risk → transient; Low risk → stable |

**Testing:**
```bash
pnpm test:narration -- --count 100   # Generate and validate 100 agents
```

### Wiki Content (`wiki/`)
- `wiki/issues/` - ~370 markdown files for global issues
- `wiki/systems/` - ~35 markdown files for simulation systems
- `wiki/mechanics/` - ~40 markdown files for causal patterns
- `wiki/primitives/` - ~16 markdown files for simulation primitives
- `wiki/principles/` - ~1120 markdown files for design principles
- `wiki/communities/` - ~23 markdown files for issue communities
- File names use kebab-case matching the `id` field in frontmatter

### Public Data (`public/`)
- `data.json` - Generated graph data (DO NOT EDIT)
- `agent-priors.v1.json` - Agent behavior priors (~5MB)
- `agent-vocab.v1.json` - Agent vocabulary definitions
- `shadow-country-map.json` - Country name mappings

## Common Tasks

### Add a New Issue
1. Add to `ISSUE-CATALOG.md` in parent repo
2. Create `wiki/issues/{id}.md` with proper frontmatter
3. Run `pnpm extract-data`

### Fix Wiki Content
1. Edit the `.md` file directly in `wiki/issues/` or `wiki/systems/`
2. Run `pnpm extract-data` to update data.json
3. Verify in browser

### Debug Graph Issues
- Check browser console for D3/canvas errors
- Verify `data.json` has correct node/edge structure
- Check `graph.ts` force simulation parameters

## Deployment

Static site deployed to any hosting:
- Vercel, Netlify, GitHub Pages, etc.
- Output: `dist/` directory
- No server required - fully static

```bash
pnpm build:full      # Extract + build
# Then deploy dist/ folder
```

---

**Last Updated**: 2025-12-29
